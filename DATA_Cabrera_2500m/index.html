<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<title>Mapa 3D amb Selector i GeoJSON</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; }
  #map { width: 100%; height: 100vh; }
  #controls {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 999;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 5px;
    color: white;
    font-family: sans-serif;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  Transparència topo ICGC:
  <input type="range" id="opacity" min="0" max="1" step="0.05" value="1">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  var map = L.map('map', {center: [42.07, 2.43], zoom: 14});

  // CAPES BASE
  var topoICGC = L.tileLayer('https://geoserveis.icgc.cat/icc_mapesmultibase/noutm/wmts/topo/{z}/{x}/{y}.jpeg', {
      attribution: 'ICGC Topogràfic',
      maxZoom: 19
  }).addTo(map);

  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'OSM',
      maxZoom: 19
  });

  // OVERLAY ORTO HISTÒRICA 1956
  var orto1956 = L.tileLayer.wms("https://geoserveis.icgc.cat/servei/catalunya/orto-territorial/wms", {
      layers: 'ortofoto_blanc_i_negre_1956',
      format: 'image/png',
      transparent: true,
      version: '1.3.0',
      crs: L.CRS.EPSG3857
  });

  // SLIDER DE TRANSPARÈNCIA
  document.getElementById('opacity').addEventListener('input', function(e){
    topoICGC.setOpacity(e.target.value);
  });

  // Carrega GeoJSON i després crea el selector
  fetch('DATA_Cabrera_2500m/01_cabrera_2500m_4326.geojson')
    .then(res => res.json())
    .then(data => {
        var geojsonLayer = L.geoJSON(data, {
            style: {color: 'red', weight: 2, fillOpacity: 0.3}
        }).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());

        // Control de capes (després que GeoJSON estigui carregat)
        var baseMaps = {
          "Topo ICGC": topoICGC,
          "OSM": osm
        };

        var overlayMaps = {
          "Orto 1956": orto1956,
          "GeoJSON": geojsonLayer
        };

        L.control.layers(baseMaps, overlayMaps, {collapsed:false}).addTo(map);
    });
</script>
</body>
</html>